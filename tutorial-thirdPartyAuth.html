<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Setup Third Party Authentication - PubNub ChatEngine</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Guides</h3><ul><li data-sidebar="getting-started"><a href="tutorial-getting-started.html">Setup</a><ul><li><a href="tutorial-install.html">Install ChatEngine</a></li><li><a href="tutorial-pubnub.html">Account setup</a></li><li><a href="tutorial-quick.html">Quick start guide</a></li></ul></li><li data-sidebar="concepts"><a href="tutorial-concepts.html">Concepts</a><ul><li><a href="tutorial-installing.html">Installing</a></li><li><a href="tutorial-initialization.html">Initialization</a></li><li><a href="tutorial-connect.html">Connect</a><ul><li><a href="tutorial-connectToChatEngine.html">Connect to ChatEngine</a></li><li><a href="tutorial-setUserState.html">Set user state</a></li><li><a href="tutorial-updateUserState.html">Update user state</a></li></ul></li><li><a href="tutorial-theuser.html">Users</a><ul><li><a href="tutorial-findAUser.html">Find a user</a></li><li><a href="tutorial-getUserState.html">Get state for online users</a></li><li><a href="tutorial-onlineOfflineEvents.html">Online and offline status</a></li></ul></li><li><a href="tutorial-chatRooms.html">Chat rooms</a><ul><li><a href="tutorial-createChat.html">Create a chat room</a></li><li><a href="tutorial-inviteUserPrivateChat.html">Invite a user to a private chat room</a></li><li><a href="tutorial-showUsers.html">Show users in a chat room</a></li><li><a href="tutorial-leaveChat.html">Leave a chat room</a></li></ul></li><li><a href="tutorial-messages.html">Messages</a><ul><li><a href="tutorial-sendMessages.html">Send messages</a></li><li><a href="tutorial-receiveMessageOnChat.html">Receive messages</a></li><li><a href="tutorial-sendDirectMessage.html">Send a direct message to a user</a></li><li><a href="tutorial-messagesHistory.html">Retrieve past messages</a></li></ul></li><li><a href="tutorial-networkEvents.html">Network events</a><ul><li><a href="tutorial-disconnectFromChatEngine.html">Disconnect from ChatEngine</a></li><li><a href="tutorial-reconnectToChatEngine.html">Reconnect To ChatEngine</a></li></ul></li><li><a href="tutorial-security.html">Security</a><ul><li><a href="tutorial-encryption.html">Encryption</a></li><li><a href="tutorial-authorization.html">Authorization</a></li></ul></li></ul></li><li data-sidebar="advancedConcepts"><a href="tutorial-advancedConcepts.html">Advanced Concepts</a><ul><li><a href="tutorial-pubSubApi.html">Access Publish and Subscribe API</a></li><li><a href="tutorial-advancedSecurity.html">Advanced Security</a><ul><li><a href="tutorial-thirdPartyAuth.html">Setup Third Party Authentication</a></li><li><a href="tutorial-aesEncryptionArchitecture.html">AES Encryption Architecture</a></li></ul></li><li><a href="tutorial-authentication.html">Authentication</a></li><li><a href="tutorial-authenticationGuide.html">Authentication Guide</a></li><li><a href="tutorial-buildAPlugin.html">Build a Plugin</a></li><li><a href="tutorial-connectDeepDive.html">Connect Deep Dive</a><ul><li><a href="tutorial-connectUser.html">Connect User to ChatEngine</a></li><li><a href="tutorial-connectGlobal.html">Connect ChatEngine.Global</a></li><li><a href="tutorial-connectMe.html">Connect ChatEngine.Me</a></li></ul></li><li><a href="tutorial-errors.html">Errors</a></li><li><a href="tutorial-integrateWithPubnubFunctions.html">Integrate with PubNub Functions</a></li><li><a href="tutorial-integrateWithSdks.html">Integrate with Server SDKs</a></li><li><a href="tutorial-namespaces.html">Namespaces</a></li><li><a href="tutorial-pubnubChannelTopology.html">PubNub Channel Topology</a><ul><li><a href="tutorial-globalChannel.html">Global Channel</a></li><li><a href="tutorial-directChannel.html">Direct Channel</a></li><li><a href="tutorial-feedChannel.html">Feed Channel</a></li><li><a href="tutorial-publicChannel.html">Public Channel</a></li><li><a href="tutorial-privateChannel.html">Private Channel</a></li></ul></li><li><a href="tutorial-templating.html">Templating</a></li><li><a href="tutorial-wildcards.html">Wildcards</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#ChatEngineCore">ChatEngineCore</a></li></ul><h3>Plugins</h3><ul><li data-sidebar="chat-engine-emoji"><a href="module-chat-engine-emoji.html">chat-engine-emoji</a><ul><li><a href="Chat.html">Chat</a><ul class='members'></ul><ul class='methods'><li data-type='method'><a href="module-chat-engine-emoji.html#~parseEmoji">parseEmoji()</a></li><li data-type='method'><a href="module-chat-engine-emoji.html#~render">render()</a></li><li data-type='method'><a href="module-chat-engine-emoji.html#~search">search()</a></li></ul></ul></li><li data-sidebar="chat-engine-gravatar"><a href="module-chat-engine-gravatar.html">chat-engine-gravatar</a><ul><li><a href="User.html">User</a><ul class='members'><li data-type='member'><a href="module-chat-engine-gravatar.html#~state%2522.%2522gravatar">state.gravatar</a></li></ul></ul></li><li data-sidebar="chat-engine-markdown"><a href="module-chat-engine-markdown.html">chat-engine-markdown</a></li><li data-sidebar="chat-engine-mute"><a href="module-chat-engine-mute.html">chat-engine-mute</a><ul><li><a href="Chat.html">Chat</a><ul class='members'></ul><ul class='methods'><li data-type='method'><a href="module-chat-engine-mute.html#~muter%2522.%2522isMuted">muter.isMuted()</a></li><li data-type='method'><a href="module-chat-engine-mute.html#~muter%2522.%2522mute">muter.mute()</a></li><li data-type='method'><a href="module-chat-engine-mute.html#~muter%2522.%2522unmute">muter.unmute()</a></li></ul></ul></li><li data-sidebar="chat-engine-online-user-search"><a href="module-chat-engine-online-user-search.html">chat-engine-online-user-search</a><ul><li><a href="Chat.html">Chat</a><ul class='members'></ul><ul class='methods'><li data-type='method'><a href="module-chat-engine-online-user-search.html#~search">search()</a></li></ul></ul></li><li data-sidebar="chat-engine-open-graph"><a href="module-chat-engine-open-graph.html">chat-engine-open-graph</a></li><li data-sidebar="chat-engine-typing-indicator"><a href="module-chat-engine-typing-indicator.html">chat-engine-typing-indicator</a><ul><li><a href="Chat.html">Chat</a><ul class='members'></ul><ul class='methods'><li data-type='method'><a href="module-chat-engine-typing-indicator.html#~typingindicator%2522.%2522startTyping">typingindicator.startTyping()</a></li><li data-type='method'><a href="module-chat-engine-typing-indicator.html#~typingindicator%2522.%2522stopTyping">typingindicator.stopTyping()</a></li></ul><ul class='events'><li data-type='event'><a href="module-chat-engine-typing-indicator.html#~event:$typingIndiciator%2522.%2522stopTyping">$typingIndiciator.stopTyping</a></li></ul></ul></li><li data-sidebar="chat-engine-unread-messages"><a href="module-chat-engine-unread-messages.html">chat-engine-unread-messages</a><ul><li><a href="Chat.html">Chat</a><ul class='members'><li data-type='member'><a href="module-chat-engine-unread-messages.html#~unreadCount">unreadCount</a></li><li data-type='member'><a href="module-chat-engine-unread-messages.html#~unreadMessages%2522.%2522isActive">unreadMessages.isActive</a></li><li data-type='member'><a href="module-chat-engine-unread-messages.html#~unreadMessages%2522.%2522unreadCount">unreadMessages.unreadCount</a></li></ul><ul class='methods'><li data-type='method'><a href="module-chat-engine-unread-messages.html#~unreadMessages%2522.%2522active">unreadMessages.active()</a></li><li data-type='method'><a href="module-chat-engine-unread-messages.html#~unreadMessages%2522.%2522active">unreadMessages.active()</a></li></ul><ul class='events'><li data-type='event'><a href="module-chat-engine-unread-messages.html#~event:$unread">$unread</a></li></ul></ul></li><li data-sidebar="chat-engine-uploadcare"><a href="module-chat-engine-uploadcare.html">chat-engine-uploadcare</a><ul><li><a href="Chat.html">Chat</a><ul class='members'></ul><ul class='methods'><li data-type='method'><a href="module-chat-engine-uploadcare.html#~uploadcare%2522.%2522bind">uploadcare.bind()</a></li></ul><ul class='events'><li data-type='event'><a href="module-chat-engine-uploadcare.html#~event:$uploadcare%2522.%2522upload">$uploadcare.upload</a></li></ul></ul></li></ul><h3>Reference</h3><ul><li data-sidebar="Chat"><a href="Chat.html">Chat</a><ul class='members'><li data-type='member'><a href="Chat.html#asleep">asleep</a></li><li data-type='member'><a href="Chat.html#channel">channel</a></li><li data-type='member'><a href="Chat.html#connected">connected</a></li><li data-type='member'><a href="Chat.html#hasConnected">hasConnected</a></li><li data-type='member'><a href="Chat.html#isPrivate">isPrivate</a></li><li data-type='member'><a href="Chat.html#meta">meta</a></li><li data-type='member'><a href="Chat.html#users">users</a></li></ul><ul class='methods'><li data-type='method'><a href="Chat.html#connect">connect()</a></li><li data-type='method'><a href="Chat.html#emit">emit()</a></li><li data-type='method'><a href="Chat.html#invite">invite()</a></li><li data-type='method'><a href="Chat.html#leave">leave()</a></li><li data-type='method'><a href="Chat.html#objectify">objectify()</a></li><li data-type='method'><a href="Chat.html#off">off()</a></li><li data-type='method'><a href="Chat.html#on">on()</a></li><li data-type='method'><a href="Chat.html#onAny">onAny()</a></li><li data-type='method'><a href="Chat.html#once">once()</a></li><li data-type='method'><a href="Chat.html#plugin">plugin()</a></li><li data-type='method'><a href="Chat.html#search">search()</a></li><li data-type='method'><a href="Chat.html#update">update()</a></li></ul><ul class='events'><li data-type='event'><a href="Chat.html#event:$%2522.%2522connected">$.connected</a></li><li data-type='event'><a href="Chat.html#event:$%2522.%2522error%2522.%2522history">$.error.history</a></li><li data-type='event'><a href="Chat.html#event:$%2522.%2522error%2522.%2522presence">$.error.presence</a></li><li data-type='event'><a href="Chat.html#event:$%2522.%2522error%2522.%2522publish">$.error.publish</a></li><li data-type='event'><a href="Chat.html#event:$%2522.%2522offline%2522.%2522disconnect">$.offline.disconnect</a></li><li data-type='event'><a href="Chat.html#event:$%2522.%2522offline%2522.%2522leave">$.offline.leave</a></li><li data-type='event'><a href="Chat.html#event:$%2522.%2522online%2522.%2522here">$.online.here</a></li><li data-type='event'><a href="Chat.html#event:$%2522.%2522online%2522.%2522join">$.online.join</a></li></ul></li><li data-sidebar="ChatEngine"><a href="ChatEngine.html">ChatEngine</a><ul class='members'><li data-type='member'><a href="ChatEngine.html#.Chat">Chat</a></li><li data-type='member'><a href="ChatEngine.html#.chats">chats</a></li><li data-type='member'><a href="ChatEngine.html#.global">global</a></li><li data-type='member'><a href="ChatEngine.html#.me">me</a></li><li data-type='member'><a href="ChatEngine.html#.pubnub">pubnub</a></li><li data-type='member'><a href="ChatEngine.html#.ready">ready</a></li><li data-type='member'><a href="ChatEngine.html#.User">User</a></li><li data-type='member'><a href="ChatEngine.html#.users">users</a></li></ul><ul class='methods'><li data-type='method'><a href="ChatEngine.html#connect">connect()</a></li><li data-type='method'><a href="ChatEngine.html#disconnect">disconnect()</a></li><li data-type='method'><a href="ChatEngine.html#off">off()</a></li><li data-type='method'><a href="ChatEngine.html#on">on()</a></li><li data-type='method'><a href="ChatEngine.html#onAny">onAny()</a></li><li data-type='method'><a href="ChatEngine.html#once">once()</a></li><li data-type='method'><a href="ChatEngine.html#proto">proto()</a></li><li data-type='method'><a href="ChatEngine.html#reauthorize">reauthorize()</a></li><li data-type='method'><a href="ChatEngine.html#reconnect">reconnect()</a></li></ul><ul class='events'><li data-type='event'><a href="ChatEngine.html#event:$%2522.%2522created%2522.%2522chat">$.created.chat</a></li><li data-type='event'><a href="ChatEngine.html#event:$%2522.%2522created%2522.%2522me">$.created.me</a></li><li data-type='event'><a href="ChatEngine.html#event:$%2522.%2522created%2522.%2522user">$.created.user</a></li><li data-type='event'><a href="ChatEngine.html#event:$%2522.%2522network%2522.%2522down%2522.%2522badrequest">$.network.down.badrequest</a></li><li data-type='event'><a href="ChatEngine.html#event:$%2522.%2522network%2522.%2522down%2522.%2522decryption">$.network.down.decryption</a></li><li data-type='event'><a href="ChatEngine.html#event:$%2522.%2522network%2522.%2522down%2522.%2522denied">$.network.down.denied</a></li><li data-type='event'><a href="ChatEngine.html#event:$%2522.%2522network%2522.%2522down%2522.%2522issue">$.network.down.issue</a></li><li data-type='event'><a href="ChatEngine.html#event:$%2522.%2522network%2522.%2522down%2522.%2522malformed">$.network.down.malformed</a></li><li data-type='event'><a href="ChatEngine.html#event:$%2522.%2522network%2522.%2522down%2522.%2522offline">$.network.down.offline</a></li><li data-type='event'><a href="ChatEngine.html#event:$%2522.%2522network%2522.%2522down%2522.%2522timeout">$.network.down.timeout</a></li><li data-type='event'><a href="ChatEngine.html#event:$%2522.%2522network%2522.%2522up%2522.%2522connected">$.network.up.connected</a></li><li data-type='event'><a href="ChatEngine.html#event:$%2522.%2522network%2522.%2522up%2522.%2522online">$.network.up.online</a></li><li data-type='event'><a href="ChatEngine.html#event:$%2522.%2522network%2522.%2522up%2522.%2522reconnected">$.network.up.reconnected</a></li><li data-type='event'><a href="ChatEngine.html#event:$%2522.%2522ready">$.ready</a></li><li data-type='event'><a href="ChatEngine.html#event:$%2522.%2522state">$.state</a></li></ul></li><li data-sidebar="Emitter"><a href="Emitter.html">Emitter</a><ul class='members'></ul><ul class='methods'><li data-type='method'><a href="Emitter.html#off">off()</a></li><li data-type='method'><a href="Emitter.html#on">on()</a></li><li data-type='method'><a href="Emitter.html#onAny">onAny()</a></li><li data-type='method'><a href="Emitter.html#once">once()</a></li><li data-type='method'><a href="Emitter.html#plugin">plugin()</a></li></ul></li><li data-sidebar="Event"><a href="Event.html">Event</a><ul class='members'><li data-type='member'><a href="Event.html#channel">channel</a></li><li data-type='member'><a href="Event.html#chat">chat</a></li><li data-type='member'><a href="Event.html#event">event</a></li><li data-type='member'><a href="Event.html#name">name</a></li></ul><ul class='methods'><li data-type='method'><a href="Event.html#off">off()</a></li><li data-type='method'><a href="Event.html#on">on()</a></li><li data-type='method'><a href="Event.html#onAny">onAny()</a></li><li data-type='method'><a href="Event.html#once">once()</a></li><li data-type='method'><a href="Event.html#plugin">plugin()</a></li></ul><ul class='events'><li data-type='event'><a href="Event.html#event:$%2522.%2522emitted%2522">$.emitted</a></li></ul></li><li data-sidebar="Me"><a href="Me.html">Me</a><ul class='members'><li data-type='member'><a href="Me.html#direct">direct</a></li><li data-type='member'><a href="Me.html#feed">feed</a></li><li data-type='member'><a href="Me.html#session">session</a></li><li data-type='member'><a href="Me.html#state">state</a></li><li data-type='member'><a href="Me.html#uuid">uuid</a></li></ul><ul class='methods'><li data-type='method'><a href="Me.html#off">off()</a></li><li data-type='method'><a href="Me.html#on">on()</a></li><li data-type='method'><a href="Me.html#onAny">onAny()</a></li><li data-type='method'><a href="Me.html#once">once()</a></li><li data-type='method'><a href="Me.html#plugin">plugin()</a></li><li data-type='method'><a href="Me.html#update">update()</a></li></ul><ul class='events'><li data-type='event'><a href="Me.html#event:$%2522.%2522invite">$.invite</a></li><li data-type='event'><a href="Me.html#event:$%2522.%2522session%2522.%2522chat%2522.%2522join">$.session.chat.join</a></li><li data-type='event'><a href="Me.html#event:$%2522.%2522session%2522.%2522chat%2522.%2522leave">$.session.chat.leave</a></li><li data-type='event'><a href="Me.html#event:$%2522.%2522session%2522.%2522group%2522.%2522restored">$.session.group.restored</a></li></ul></li><li data-sidebar="RootEmitter"><a href="RootEmitter.html">RootEmitter</a><ul class='members'></ul><ul class='methods'><li data-type='method'><a href="RootEmitter.html#off">off()</a></li><li data-type='method'><a href="RootEmitter.html#on">on()</a></li><li data-type='method'><a href="RootEmitter.html#onAny">onAny()</a></li><li data-type='method'><a href="RootEmitter.html#once">once()</a></li></ul></li><li data-sidebar="Search"><a href="Search.html">Search</a><ul class='members'><li data-type='member'><a href="Search.html#chat">chat</a></li><li data-type='member'><a href="Search.html#config">config</a></li><li data-type='member'><a href="Search.html#hasMore">hasMore</a></li></ul><ul class='methods'><li data-type='method'><a href="Search.html#next">next()</a></li><li data-type='method'><a href="Search.html#off">off()</a></li><li data-type='method'><a href="Search.html#on">on()</a></li><li data-type='method'><a href="Search.html#onAny">onAny()</a></li><li data-type='method'><a href="Search.html#once">once()</a></li><li data-type='method'><a href="Search.html#plugin">plugin()</a></li></ul><ul class='events'><li data-type='event'><a href="Search.html#event:$%2522.%2522page%2522.%2522request">$.page.request</a></li><li data-type='event'><a href="Search.html#event:$%2522.%2522page%2522.%2522response">$.page.response</a></li><li data-type='event'><a href="Search.html#event:$%2522.%2522search%2522.%2522finish">$.search.finish</a></li><li data-type='event'><a href="Search.html#event:$%2522.%2522search%2522.%2522pause%2522">$.search.pause</a></li><li data-type='event'><a href="Search.html#event:$%2522.%2522search%2522.%2522start">$.search.start</a></li></ul></li><li data-sidebar="Session"><a href="Session.html">Session</a><ul class='members'><li data-type='member'><a href="Session.html#chats">chats</a></li><li data-type='member'><a href="Session.html#sync">sync</a></li></ul><ul class='methods'><li data-type='method'><a href="Session.html#off">off()</a></li><li data-type='method'><a href="Session.html#on">on()</a></li><li data-type='method'><a href="Session.html#onAny">onAny()</a></li><li data-type='method'><a href="Session.html#once">once()</a></li><li data-type='method'><a href="Session.html#plugin">plugin()</a></li></ul></li><li data-sidebar="User"><a href="User.html">User</a><ul class='members'><li data-type='member'><a href="User.html#direct">direct</a></li><li data-type='member'><a href="User.html#feed">feed</a></li><li data-type='member'><a href="User.html#state">state</a></li><li data-type='member'><a href="User.html#uuid">uuid</a></li></ul><ul class='methods'><li data-type='method'><a href="User.html#off">off()</a></li><li data-type='method'><a href="User.html#on">on()</a></li><li data-type='method'><a href="User.html#onAny">onAny()</a></li><li data-type='method'><a href="User.html#once">once()</a></li><li data-type='method'><a href="User.html#plugin">plugin()</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">Setup Third Party Authentication</h1>
    

    <section>

<header>
    

    <!-- <h2>Setup Third Party Authentication</h2> -->
</header>

<article>
    <h1>How to Use This Guide</h1><p>The following guide shows ChatEngine developers how to setup 3rd party authentication. To clearly illustrate the approach, a <em>Facebook Login App</em> is used as the authenticator. Regardless of which 3rd party service is used, the security mechanics remain the same.</p>
<blockquote>
<ol>
<li>ChatEngine client inputs login credentials to 3rd party authenticator</li>
<li>3rd party returns authKey upon successful authentication</li>
<li>ChatEngine server receives authKey and grants/authorizes user access to appropriate ChatEngine channels (for time specified by authTTL) via <a href="https://www.pubnub.com/docs/pubnub-rest-api-documentation#pubnub-access-manager-pam">PAM</a>.</li>
</ol>
</blockquote>
<h1>How ChatEngine 3rd Party Authentication Works</h1><p>This guide explains how to setup 3rd authentication within the ChatEngine platform. Its important to note that the following security pattern is not restricted to using the Facebook Login App service:  it can be used in conjunction with substantially any third-party authentication service.</p>
<h3>Login flow to 3rd Party Provider via ChatEngine (e.g. FB Login App):</h3><p><img src="./ChatEngineAuthFB1.png" alt="Flowchart0" title="Blah"></p>
<h3>Publish Chat Message (post-login routing):</h3><p><img src="./ChatEngineAuthMsgFlow.png" alt="Flowchart1" title="Blah"></p>
<h2>JS SDK connects to servers with a Facebook uuid and authToken</h2><p>The Facebook JS SDK provides a method to login (and a GUI element too!). When Facebook tells us we're logged in, we boot ChatEngine with the authentication information that get from Facebook. This includes a user object, an id, and the Facebook Access Token.</p>
<p>Check out the docs for <a href="https://developers.facebook.com/docs/facebook-login/access-tokens#usertokens">Facebook Access Tokens</a> and the properties for <a href="https://www.pubnub.com/docs/chat-engine/reference/chatengine#connect">ChatEngine.connect()</a>.</p>
<pre class="prettyprint source lang-js"><code>function buildChatEngine(fbMe, fbAccessToken) {
    ChatEngine.connect(fbMe.id, fbMe, fbAccessToken);
};</code></pre><p>Authentication information is stored in memory on the client and sent with every single ChatEngine request.</p>
<h2>Server Functions receives request but does not execute</h2><p>ChatEngine Server Function receives the request and immediately proxies it to the Gateway Function. It will not continue unless it receives <code>{ allow: true }</code> from the Gateway.</p>
<p>The token and user information is forwarded to the Gateway function.</p>
<h2>The Gateway Function Authorizes (or Rejects)</h2><p>The Gateway Function returns &quot;allow&quot; <code>true</code> or <code>false</code> depending on the policy. Authentication policies are defined on a <strong>per route basis</strong>. In general, a policy is in charge of &quot;who&quot; can do &quot;what.&quot;</p>
<p>As soon as ChatEngine connect is called, it makes a request to <code>/login</code>. This is the only open route in our authorization policy.</p>
<p>The login route should take the user's information and return a successful response if it is valid. The Gateway function will then store this information in it's own cache, so that 3rd party servers do not have to be contacted in the future.</p>
<p>In this example, notice how login needs to <code>validateFBToken</code>. See below for what that does.</p>
<p>Notice how the 'grant' policy calls a different function called <code>isOverAge</code>. This asks Facebook to validate that the user is over 13 before giving them access to any new chat (the /grant endpoint).</p>
<p>All the information from the original request is available in the policy gateway.</p>
<h2>Gateway Validates FB Token on Login</h2><p>This function validates the supplied uuid and authToken to grant the user access to ChatEngine. It uses the xhr module to call Facebook's debug endpoint and validate that the user token is legitimate and that it matches who the user claims to be.</p>
<h2>The Server executes the business logic on good response from gateway</h2><p>If the token is valid on /login, the Server Function stores the <code>authKey</code> in the db keyed by <code>uuid</code>. This acts as a session cache, allowing us to validate the authToken ourselves in future requests; preventing us from hitting Facebook's servers every time we need to check if the user is valid (which is every time).</p>
<p>If this were the /grant endpoint, the server would grant the user access to some chat. And if it were a invite request, it might send someone else a chat invite.</p>
<h1>Every PubNub and Server request thereafter is validated</h1><p>By comparing the uuid and the cached authToken, we can validate that the user is who they say they are. This is because Facebook told us so, and we cached that in the db.</p>
<p>All other ChatEngine requests will use this method rather than asking Facebook
every time.</p>
<p>With cached session validation and protected routes, we have a secure way allowing access to chat rooms and other functions.</p>
<h1>Setup</h1><h2>Checkout The ChatEngine Repository</h2><p>This example depends on compiled JS SDK found in the <a href="https://github.com/pubnub/chat-engine/tree/auth-policy-refactor">auth-policy-refactor</a> branch.</p>
<p>Make sure to compile this version of ChatEngine in the sibling directory:</p>
<pre class="prettyprint source"><code>git clone git@github.com:pubnub/chat-engine.git
git checkout auth-policy-refactor</code></pre><p>The remaining file assets are appended to the bottom of the guide.</p>
<h2>I. Facebook Login App</h2><ol>
<li><a href="https://developers.facebook.com/apps">Naviate to the following</a> and login to FB developer landing page.</li>
<li>Next select <em>Add a New App</em> and follow the setup wizard.</li>
<li>Enter in your app's domain address into <code>Site URL</code> and the <code>App Domain</code> fields (e.g. <code>https://localhost</code> &amp; <code>localhost</code> respectively).
<img src="./FB_App_settings_1.png" alt="FB App Settings 1" title="blah">
<img src="./FB_App_settings.png" alt="FB App Settings 0" title="blah"></li>
<li>Save settings.</li>
<li>Copy the <code>appID</code> value into the client code to replace the hardcoded value used by the <code>FB.init()</code> method in <code>../chat-engine-scratch/auth-guide/index.html</code>.</li>
<li>Copy and save the <code>App Secret</code> for later use.</li>
<li>Once app has been created, copy and paste the <code>appID</code> inside the <code>FB.init()</code> method used in the file: <code>../index.html</code>.</li>
<li>Lastly, paste the <code>App Secret</code> value into the <code>chat-engine-gateway</code> Function, should look something like: <code>const appID = '&lt;INSERT_appID&gt;';</code>.</li>
</ol>
<h2>II. Functions</h2><p>The following are updated PubNub functions that implements swap-able auth policies to
work with 3rd party services (see bottom of guide for copies of Functions code).</p>
<table>
<thead>
<tr>
<th style="text-align:center">Function Name</th>
<th style="text-align:center">Function Type</th>
<th style="text-align:center">Channel Name</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">rest-gateway</td>
<td style="text-align:center">On Request</td>
<td style="text-align:center">chat-engine-gateway</td>
</tr>
<tr>
<td style="text-align:center">rest-sever</td>
<td style="text-align:center">On Request</td>
<td style="text-align:center">chat-engine-server</td>
</tr>
<tr>
<td style="text-align:center">msg-validator</td>
<td style="text-align:center">Before Publish</td>
<td style="text-align:center">*</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Note: Functions code appended to bottom of guide for ease of copying &amp; pasting.</p>
</blockquote>
<ol>
<li>Copy and paste Functions code (in table above) into a Module.</li>
<li>Within the <code>rest-gateway</code> Function, hardcode the <code>`appID</code> value.</li>
<li>Select the <code>My Secrets</code> button and input the following key-val: <code>{'myFBSecret': '_COPY_PASTE_APP_SECRET_HERE_'}</code>, then save.</li>
<li>Restart Module.</li>
</ol>
<h2>III. Client</h2><ol>
<li>Go to the chat-engine:auth-policy-refactor repo.</li>
<li><code>npm install</code></li>
<li>Copy the index.html (at page bottom) into a directory at the same level as chat-engine repo.</li>
<li>Copy and paste <code>publishKey</code> &amp; <code>subscribeKey</code> values into <code>index.html`</code>.</li>
<li>Ensure that <code>appID</code> value from FB has been set within <code>../index.html</code>.</li>
<li>FB requires you server applications over SSL. To serve the client code over https perform the following: <code>openssl req -newkey rsa:2048 -new -nodes -x509 -days 3650 -keyout key.pem -out cert.pem</code>
<code>npm install http-server -g</code>
<code>http-server --ssl -C chat-engine-scratch/auth-preview/cert.pem -K chat-engine-scratch/auth-preview/key.pem</code></li>
<li>Open <code>../index.html</code></li>
<li>Boom! Login to FB and chat away!</li>
</ol>
<h2>Cost vs. Security</h2><p>The above authentication heavily relies on the usage of an <em>onBeforePublish</em> Function that is registered to listen on all channels ('*') on that subkey. Meaning, every published msg via CE will be authenticated by the <em>onBeforePublish</em> Function. Though a costly architecture, the approach is the most secure and expensive. Any reductions to cost would subsequently lead to a less secure architecture. <em>Lets explore these trade-offs..</em></p>
<h3>Option #1: Everytime: <em>High Cost, High Security</em>:</h3><p>By far the most costly and secure option. On initilization of CE, user's third-party authentication information is sent to CE <em>login</em> rest Function endpoint. The Function handles requests to a third-party authenticator and caches the response within Function's KV store for cached authentication. If successfully authenticated via third-party, all subsequent CE calls are validated by <em>onBeforePublish</em> Function that checks message's <code>authKey</code> matches the associated user's <code>authKey</code> previously saved in the KV store.</p>
<blockquote>
<p>Configuration:</p>
<ol>
<li>Follow the above guide.</li>
</ol>
</blockquote>
<h3>Option #2: Periodic: <em>Moderate Cost, Moderate Security</em>:</h3><p>If the cost of authenticating every CE msg gives you the willies, but require more than just a single authorization (i.e. SSO), implementing a periodical authorization can offer users moderate security.</p>
<p>The mechanics of a periodical authorization requires SSO with some third-party credentials. Once the CE backend has determined the validity of the creds, the rest-server Function grants/authorizes users access to various channels required by CE for a given authTTL.</p>
<blockquote>
<p>Configuration:</p>
<ol>
<li>Remove the <em>onBeforePublish</em> Function;</li>
<li>Update chat-engine-rest.js Functions code to grant PAM access with a specified TTL which expires every X seconds.</li>
<li>Restart module.</li>
<li>Update ChatEngine client code to retry authenticating upon expired authTTL.</li>
</ol>
</blockquote>
<h3>Option #3:  Single Sign On: <em>Low Cost, Low Security</em>:</h3><p>The least secure authentication pattern relies on a single authentication attempt at the initilization of a CE user. When initilizing CE, once a user has entered their authentication credentials into the client, a <em>login</em> attempt is sent to CE <em>login</em> rest Function endpoint. Once successfully authenticated, CE will then grant PAM access to the user. No further authentication occurs until user <em>logs in</em> again.</p>
<blockquote>
<p>Configuration:</p>
<ol>
<li>Remove the <em>onBeforePublish</em> Function.</li>
<li>Restart Module.</li>
</ol>
</blockquote>
<h2>Code Snippets</h2>
</article>

</section>

</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>